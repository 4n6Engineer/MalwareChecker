from __future__ import print_function
from virus_total_apis import PublicApi as VirusTotalPublicApi
import argparse
import sys
import json
import time
import os
import zipfile
DATEANDTIME = time.strftime("%d%m%Y%H%M%S")
Konum = os.path.dirname(os.path.abspath(__file__))

def str_to_file(text, filename):
    output = open(filename, "w")
    output.write(text)
    output.close()

baslangic = ''' Bu arac VirusTotal veritabani uzerinden hash karsilastirmasi yaparak HTML rapor uretmektedir. \n Ornek Kullanim: MalwareChecker.py Source_Hash_List.txt'''
goster = argparse.ArgumentParser(description=baslangic)
goster.add_argument("-hash", "--hash", type=str, help='Hash turu (md5, MD5, sha1, SHA1, sha256,SHA256)')
goster.add_argument("file", type=str, help='Hash Listesi (txt dosyasi)')



ibrhm = goster.parse_args()


#VirusTotal API Degerini Buraya Giriniz.
virustotal = VirusTotalPublicApi('b18dc7be4b9979a9d695c6ba579628623f0930c567a36d9c0a664a8d9c946d89')

dashboard_mesaj = '''
  __  __       _                           _____ _               _             
 |  \/  |     | |                         / ____| |             | |            
 | \  / | __ _| |_      ____ _ _ __ ___  | |    | |__   ___  ___| | _____ _ __ 
 | |\/| |/ _` | \ \ /\ / / _` | '__/ _ \ | |    | '_ \ / _ \/ __| |/ / _ \ '__|
 | |  | | (_| | |\ V  V / (_| | | |  __/ | |____| | | |  __/ (__|   <  __/ |   
 |_|  |_|\__,_|_| \_/\_/ \__,_|_|  \___|  \_____|_| |_|\___|\___|_|\_\___|_|   
                    
         Malware Checker (VirusTotal) V1.4 | Twitter: 4n6Engineer  
         
                        Developer: ibrahim BALOGLU                                                                     
                                                                               
'''
print(dashboard_mesaj)
blglu = open(sys.argv[1])
lines = blglu.readlines()
print("Scan Started...\n")

zip_file_name = 'file.ibaloglu'
zip_core = zipfile.ZipFile(zip_file_name)
zip_core.extractall(r'.')



rapor_adi=Konum+"\Report_"+DATEANDTIME+".html"
myFile= open(rapor_adi, 'w+')
html_baslangic = """
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <title>Malware Checker Report</title>
    <link rel="stylesheet" href="theme_scripts/bootstrap.css">
	<link rel="stylesheet" href="theme_scripts/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="theme_scripts/buttons.bootstrap4.min.css">
	<link rel="stylesheet" href="theme_scripts/responsive.bootstrap4.min.css">
</head>
<body>
<br><b><center style="font-size: 33px;">Malware Checker Report</center></b><br>
<style>

.footer {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  background-color: #42A5F5;
  color: white;
  text-align: center;
}
</style>
	<table id="example" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">

 <thead>
            <tr>
                <th>Hash</th>
                <th>Kaspersky</th>
                <th>Fortinet</th>
                <th>Symantec</th>
                <th>Skor</th>
                <th>Scanned Date</th>
                <th>Detail Url</th>
            </tr>
        </thead>
<tbody>
            <tr><td>


"""
sayac=0
myFile.write(html_baslangic)
for line in lines:
    cevap_kontrol = virustotal.get_file_report(line)
    json_verisi = json.loads(json.dumps(cevap_kontrol))
    hash=str(line).replace("\n","")
    sayac+=1

    if str(json_verisi['response_code'])=='204':
        print(" \n Gunluk API siniri asildi. Lutfen VirusTotele uye olarak kendi APInizi koda ekleyeniz.\n Detaylar icin README dosyasini okuyabilirsiniz.")
        break
    else:
        try:
            if json_verisi['results']['response_code'] == 1 and json_verisi['results']['positives']>0:

                        url = json_verisi['results'][ibrhm.hash]
                        myFile.write(hash)
                        myFile.write('</td><td>')
                        if 'Kaspersky' in json_verisi['results']['scans']:
                            myFile.write(str(json_verisi['results']['scans']['Kaspersky']['result']))
                        else:
                            myFile.write("Hash Not Found!")
                        myFile.write('</td><td>')
                        if 'Fortinet' in json_verisi['results']['scans']:
                            myFile.write(str(json_verisi['results']['scans']['Fortinet']['result']))
                        else:
                            myFile.write("Hash Not Found!")
                        myFile.write('</td><td>')
                        if 'Symantec' in json_verisi['results']['scans']:
                             myFile.write(str(json_verisi['results']['scans']['Symantec']['result']))
                        else:
                            myFile.write("Hash Not Found!")
                        myFile.write('</td><td>')
                        myFile.write(str(json_verisi['results']['positives']))
                        print("[", sayac, "]", hash, " Detected. Skor: [ ",str(json_verisi['results']['positives'])," ]")
                        myFile.write('</td><td>')
                        myFile.write(json_verisi['results']['scan_date'])
                        myFile.write('</td><td>')
                        myFile.write(' <a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % url)
                        myFile.write('</td></tr><tr><td>')

            elif json_verisi['results']['response_code'] == 1 and json_verisi['results']['positives'] == 0:
                url = json_verisi['results'][ibrhm.hash]
                try:
                    myFile.write(hash)
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td><td>')
                    myFile.write('0')
                    myFile.write('</td><td>')
                    myFile.write(json_verisi['results']['scan_date'])
                    myFile.write('</td><td>')
                    myFile.write(' <a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> <button class ="btn btn-secondary buttons-pdf buttons-html5" tabindex="0" aria-controls="example" type="button" > <span>Click</span> </button> </a>' % url)
                    myFile.write('</td></tr><tr><td>')
                except:
                    pass
            else:
                try:
                    myFile.write(hash)
                    myFile.write('</td><td>')
                    myFile.write('Hash Not Found!')
                    myFile.write('</td><td>')
                    myFile.write('Hash Not Found!')
                    myFile.write('</td><td>')
                    myFile.write('Hash Not Found!')
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td><td>')
                    myFile.write('N/A')
                    myFile.write('</td></tr><tr><td>')
                except:
                    pass


            time.sleep(15)
        except:
            pass

blglu.close()
if str(json_verisi['response_code'])!='204':
    print("\n Reported Success. \n Report File Path: ", rapor_adi," ")
html_bitir = """
</td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
 </tbody>
    </table>
<br><br><br><div class="footer">
  <p>Copyright &copy; 2020 Malware Checker (VirusTotal)  |   Developer: <a href="http://www.twitter.com/4n6Engineer" target="_blank" style=" text-decoration: none;color: white;"> ibrahim BALOGLU</a></p>
</div>

<script src="theme_scripts/jquery-3.3.1.js"></script>
    <script src="theme_scripts/jquery.dataTables.min.js"></script>
    <script src="theme_scripts/dataTables.bootstrap4.min.js"></script>
    <script src="theme_scripts/dataTables.buttons.min.js"></script>
    <script src="theme_scripts/buttons.bootstrap4.min.js"></script>
    <script src="theme_scripts/jszip.min.js"></script>
    <script src="theme_scripts/pdfmake.min.js"></script>
    <script src="theme_scripts/vfs_fonts.js"></script>
    <script src="theme_scripts/buttons.html5.min.js"></script>
    <script src="theme_scripts/buttons.print.min.js"></script>
    <script src="theme_scripts/buttons.colVis.min.js"></script>
    <script src="theme_scripts/dataTables.responsive.min.js"></script>
    <script src="theme_scripts/responsive.bootstrap4.min.js"></script>
    <script>
	$(document).ready(function() {
	    var table = $('#example').DataTable( {
	        lengthChange: false,
	        buttons: [ 'copy', 'excel', 'csv', 'pdf', 'colvis' ]
	    } );
	 
	    table.buttons().container()
	        .appendTo( '#example_wrapper .col-md-6:eq(0)' );
	} );
     </script>
</body>
</html>
 """
myFile.write(html_bitir)
