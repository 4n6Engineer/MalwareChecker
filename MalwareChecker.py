from __future__ import print_function
from virus_total_apis import PublicApi as VirusTotalPublicApi
import argparse
import sys
import json
import time
DATEANDTIME = time.strftime("%d%m%Y%H%M%S")

def str_to_file(text, filename):
    output = open(filename, "w")
    output.write(text)
    output.close()

baslangic = ''' Bu arac VirusTotal veritabani uzerinden hash karsilastirmasi yaparak HTML rapor uretmektedir. \n Ornek Kullanim: MalwareChecker.py Dosya.txt -hash md5'''
goster = argparse.ArgumentParser(description=baslangic)
goster.add_argument("-hash", "--hash", type=str, help='Hash turu (md5, sha1, sha256)')
goster.add_argument("file", type=str, help='Hash Listesi (txt dosyasi)')



ibrhm = goster.parse_args()


#VirusTotal API Degeri
virustotal = VirusTotalPublicApi('b18dc7be4b9979a9d695c6ba579628623f0930c567a36d9c0a664a8d9c946d89')

dashboard_mesaj = '''
  __  __       _                           _____ _               _             
 |  \/  |     | |                         / ____| |             | |            
 | \  / | __ _| |_      ____ _ _ __ ___  | |    | |__   ___  ___| | _____ _ __ 
 | |\/| |/ _` | \ \ /\ / / _` | '__/ _ \ | |    | '_ \ / _ \/ __| |/ / _ \ '__|
 | |  | | (_| | |\ V  V / (_| | | |  __/ | |____| | | |  __/ (__|   <  __/ |   
 |_|  |_|\__,_|_| \_/\_/ \__,_|_|  \___|  \_____|_| |_|\___|\___|_|\_\___|_|   
                    
         Malware Kontrol Araci (VirusTotal) V1.0 | Twitter: 4n6Engineer  
         
                        Developer: ibrahim BALOGLU                                                                     
                                                                               
'''
print(dashboard_mesaj)
blglu = open(sys.argv[1])
lines = blglu.readlines()
rapor_adi="Rapor_"+DATEANDTIME+".html"
myFile= open(rapor_adi, 'w+')
html_baslangic = """
<!DOCTYPE html>
<html>
<head>
<title>Malware Hash Kontrol</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>


* {
  box-sizing: border-box;
}

#myInput {
  background-image: url('searchicon.png');
  background-position: 10px 10px;
  background-repeat: no-repeat;
  width: 100%;
  font-size: 16px;
  padding: 12px 20px 12px 40px;
  border: 1px solid #ddd;
  margin-bottom: 12px;
}

#myTable {
  border-collapse: collapse;
  width: 100%;
  border: 1px solid #ddd;
  font-size: 18px;
}

#myTable th, #myTable td {
  text-align: left;
  padding: 12px;
}

#myTable tr {
  border-bottom: 1px solid #ddd;
}

#myTable tr.header, #myTable tr:hover {
  background-color: #f1f1f1;
}
.footer {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  background-color: #42A5F5;
  color: white;
  text-align: center;
}
</style>
</head>
<body>
<BR> <BR>
<input type="text" id="myInput" onkeyup="myFunction()" placeholder="HASH ARAMASI..." title="Type in a name">



<table id="myTable">
  <tr class="header">
    <th>Hash</th>
    <th>Kaspersky</th>
    <th>Fortinet</th>
    <th>Symantec</th>
    <th>Skor</th>
    <th>Taratilma Tarihi</th>
    <th>Detay</th>
    </tr>
    <tr>
  <td>
"""
sayac=0
myFile.write(html_baslangic)
for line in lines:
    cevap_kontrol = virustotal.get_file_report(line)

    json_verisi = json.loads(json.dumps(cevap_kontrol))
    hash=json_verisi['results']['resource']
    sayac+=1
    print("[",sayac,"]",hash," Kontrol Edildi.")
    if json_verisi['results']['response_code'] == 1 and json_verisi['results']['positives']>0:
            url = json_verisi['results'][ibrhm.hash]
            myFile.write(json_verisi['results'][ibrhm.hash])
            myFile.write('</td><td>')
            myFile.write(json_verisi['results']['scans']['Kaspersky']['result'])
            myFile.write('</td><td>')
            myFile.write(json_verisi['results']['scans']['Fortinet']['result'])
            myFile.write('</td><td>')
            myFile.write(json_verisi['results']['scans']['Symantec']['result'])
            myFile.write('</td><td>')
            myFile.write(str(json_verisi['results']['positives']))
            myFile.write('</td><td>')
            myFile.write(json_verisi['results']['scan_date'])
            myFile.write('</td><td>')
            myFile.write('<a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> Tikla</a>' % url)
            myFile.write('</td></tr><tr><td>')
    elif json_verisi['results']['response_code'] == 1 and json_verisi['results']['positives'] == 0:
        url = json_verisi['results'][ibrhm.hash]

        myFile.write(hash)
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('0')
        myFile.write('</td><td>')
        myFile.write(json_verisi['results']['scan_date'])
        myFile.write('</td><td>')
        myFile.write('<a href="https://www.virustotal.com/gui/file/%s/details" target="_blank"> Tikla</a>' % url)
        myFile.write('</td></tr><tr><td>')

    else:
        myFile.write(hash)
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td><td>')
        myFile.write('N/A')
        myFile.write('</td></tr><tr><td>')

    #1 dakika max 4 sorgu yapildigindan her sorguda 15 sn beklet.
    time.sleep(15)
blglu.close()

html_bitir = """
<div class="footer">
  <p>Copyright &copy; 2020 Malware Hash Kontrol (VirusTotal)  |   Designed by <a href="http://www.twitter.com/4n6Engineer" target="_blank" style=" text-decoration: none;color: white;"> ibrahim BALOGLU</a></p>
</div>
<script>
function myFunction() {
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById("myInput");
  filter = input.value.toUpperCase();
  table = document.getElementById("myTable");
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[0];
    if (td) {
      txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }       
  }
}
</script>

</body>
</html>
 """
myFile.write(html_bitir)


